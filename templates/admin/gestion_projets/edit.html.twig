{% extends 'admin/admin_base.html.twig' %}

{% block title %}Modifier — {{ projet.titre }}{% endblock %}

{% block body %}

{% include 'components/_flash_messages.html.twig' %}

<div class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-4">
    <div>
        <h1 class="admin-page-header__title">Modifier le projet</h1>
        <p class="admin-page-header__sub">{{ projet.titre }}</p>
    </div>
    <a href="{{ path('app_show_gestion_projets', {id: projet.id}) }}" class="dc-btn dc-btn--outline">
        <i class="fa-solid fa-arrow-left"></i>
        Retour
    </a>
</div>

{{ form_start(form, {attr: {novalidate: 'novalidate', enctype: 'multipart/form-data'}}) }}

<div class="row g-4">

    {# ── Colonne principale : infos ── #}
    <div class="col-12 col-lg-7">
        <div class="dc-card mb-4">
            <div class="dc-card__head">
                <span class="dc-card__title">
                    <i class="fa-solid fa-circle-info"></i>
                    Informations générales
                </span>
            </div>
            <div class="dc-card__body">

                <div class="mb-3">
                    <label class="dc-form-label" for="{{ form.titre.vars.id }}">Titre <span class="text-danger">*</span></label>
                    {{ form_widget(form.titre, {attr: {class: 'dc-form-control' ~ (form.titre.vars.errors|length ? ' is-invalid' : '')}}) }}
                    {% if form.titre.vars.errors|length > 0 %}
                        <span class="dc-field-error">
                            <i class="fa-solid fa-circle-exclamation"></i>
                            <span>{{ form_errors(form.titre) }}</span>
                        </span>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="dc-form-label" for="{{ form.description.vars.id }}">Description</label>
                    {{ form_widget(form.description, {attr: {class: 'dc-form-control'}}) }}
                    {% if form.description.vars.errors|length > 0 %}
                        <span class="dc-field-error">
                            <i class="fa-solid fa-circle-exclamation"></i>
                            <span>{{ form_errors(form.description) }}</span>
                        </span>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="dc-form-label" for="{{ form.localisation.vars.id }}">Localisation</label>
                    {{ form_widget(form.localisation, {attr: {class: 'dc-form-control'}}) }}
                </div>

                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label class="dc-form-label" for="{{ form.date.vars.id }}">Date</label>
                        {{ form_widget(form.date, {attr: {class: 'dc-form-control'}}) }}
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="dc-form-label" for="{{ form.taille.vars.id }}">Taille</label>
                        {{ form_widget(form.taille, {attr: {class: 'dc-form-control'}}) }}
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="dc-form-label" for="{{ form.maitreOuvrage.vars.id }}">Maître d'ouvrage</label>
                        {{ form_widget(form.maitreOuvrage, {attr: {class: 'dc-form-control'}}) }}
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="dc-form-label" for="{{ form.maitreOeuvre.vars.id }}">Maître d'œuvre</label>
                        {{ form_widget(form.maitreOeuvre, {attr: {class: 'dc-form-control'}}) }}
                    </div>
                </div>

            </div>
        </div>
    </div>

    {# ── Colonne latérale : images ── #}
    <div class="col-12 col-lg-5">

        {# ── Section 1 : Cover ── #}
        <div class="dc-card mb-4">
            <div class="dc-card__head">
                <span class="dc-card__title">
                    <i class="fa-solid fa-star text-warning"></i>
                    Image de couverture
                </span>
            </div>
            <div class="dc-card__body">

                {% set cover = projet.coverImage %}
                {% if cover %}
                    <p class="text-muted small mb-2">Cover actuelle :</p>
                    <div class="projet-cover-preview mb-3">
                        <img src="{{ path('app_voir_image_projet_admin', {id: cover.id}) }}" alt="Cover actuelle">
                        <span class="projet-cover-preview__badge">
                            <i class="fa-solid fa-star"></i> Cover
                        </span>
                    </div>
                {% endif %}

                <p class="text-muted small mb-3">
                    {{ cover ? 'Remplacer la cover (optionnel) :' : 'Aucune cover — uploadez-en une :' }}
                    <span class="d-block" style="font-size:0.75rem;">La cover est toujours en position 1.</span>
                </p>

                {{ form_widget(form.coverFile, {attr: {
                    id: 'coverFileInput',
                    class: 'pj-file-input-hidden'
                }}) }}

                {% if form.coverFile.vars.errors|length > 0 %}
                    <span class="dc-field-error mb-2 d-flex">
                        <i class="fa-solid fa-circle-exclamation"></i>
                        <span>{{ form_errors(form.coverFile) }}</span>
                    </span>
                {% endif %}

                <label for="{{ form.coverFile.vars.id }}"
                       id="coverDropZone"
                       class="pj-dropzone{% if form.coverFile.vars.errors|length > 0 %} is-invalid{% endif %}">
                    <i class="fa-solid fa-image pj-dropzone__icon" id="coverDropIcon"></i>
                    <span class="pj-dropzone__text" id="coverDropText">Cliquez ou glissez votre image ici</span>
                    <span class="pj-dropzone__hint">JPEG, PNG, WebP — 5 Mo max</span>
                </label>

                <div id="coverPreview" class="mt-3" style="display:none;">
                    <div class="projet-cover-preview">
                        <img id="coverPreviewImg" src="" alt="Nouvelle cover">
                        <button type="button" class="projet-cover-preview__remove" id="coverPreviewRemove" title="Retirer">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        <span class="projet-cover-preview__badge">
                            <i class="fa-solid fa-star"></i> Nouvelle cover
                        </span>
                    </div>
                </div>
            </div>
        </div>

        {# ── Section 2 : Carousel existant en BDD ── #}
        {% set carouselImages = projet.carouselImages %}
        {% if carouselImages is not empty %}
        <div class="dc-card mb-4">
            <div class="dc-card__head">
                <span class="dc-card__title">
                    <i class="fa-solid fa-images"></i>
                    Carousel actuel ({{ carouselImages|length }} image{{ carouselImages|length > 1 ? 's' : '' }})
                </span>
            </div>
            <div class="dc-card__body">
                <p class="text-muted small mb-3">
                    Cochez <i class="fa-solid fa-trash fa-xs"></i> pour supprimer une image lors de la sauvegarde.
                </p>
                <div class="projet-images-edit-grid">
                    {% for image in carouselImages %}
                        <div class="projet-edit-thumb" id="thumb-{{ image.id }}">
                            <img src="{{ path('app_voir_image_projet_admin', {id: image.id}) }}"
                                 alt="Image carousel {{ loop.index }}" loading="lazy">
                            <span class="projet-edit-thumb__order">{{ loop.index + 1 }}</span>
                            <label class="projet-edit-thumb__delete-check" title="Marquer pour suppression">
                                <input type="checkbox"
                                       name="images_to_delete[]"
                                       value="{{ image.id }}"
                                       class="projet-delete-checkbox">
                                <span class="projet-edit-thumb__delete-overlay">
                                    <i class="fa-solid fa-trash"></i>
                                </span>
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {# ── Section 3 : Ajouter des images carousel ── #}
        <div class="dc-card mb-4">
            <div class="dc-card__head">
                <span class="dc-card__title">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                    Ajouter des images au carousel
                </span>
            </div>
            <div class="dc-card__body">
                <p class="text-muted small mb-3">
                    Ajoutées à la suite du carousel existant. Sélection multiple possible.
                </p>

                {{ form_widget(form.carouselFiles, {attr: {
                    id: 'carouselFilesInput',
                    class: 'pj-file-input-hidden',
                    multiple: 'multiple',
                    accept: 'image/jpeg,image/png,image/webp'
                }}) }}

                {% if form.carouselFiles.vars.errors|length > 0 %}
                    <span class="dc-field-error mb-2 d-flex">
                        <i class="fa-solid fa-circle-exclamation"></i>
                        <span>{{ form_errors(form.carouselFiles) }}</span>
                    </span>
                {% endif %}

                {# Label natif → déclenchement garanti sans JS #}
                <label for="carouselFilesInput"
                       id="carouselDropLabel"
                       class="pj-dropzone pj-dropzone--multi">
                    <i class="fa-solid fa-cloud-arrow-up pj-dropzone__icon"></i>
                    <span class="pj-dropzone__text" id="carouselDropText">Cliquez ou glissez vos images ici</span>
                    <span class="pj-dropzone__hint">JPEG, PNG, WebP — 5 Mo max — sélection multiple</span>
                </label>
            </div>
        </div>

        {# ── Section 4 : Preview nouvelles images (ordre) ── #}
        <div id="orderPreviewWrap" style="display:none;">
            <div class="dc-card">
                <div class="dc-card__head">
                    <span class="dc-card__title">
                        <i class="fa-solid fa-list-ol"></i>
                        Nouvelles images à ajouter
                    </span>
                </div>
                <div class="dc-card__body">
                    <p class="text-muted small mb-3">
                        Cliquez sur <i class="fa-solid fa-xmark fa-xs"></i> pour retirer une image.
                    </p>
                    <div class="pj-order-grid" id="orderPreviewGrid"></div>
                </div>
            </div>
        </div>

    </div>

</div>

<div class="d-flex justify-content-end gap-2 mt-4">
    <a href="{{ path('app_show_gestion_projets', {id: projet.id}) }}" class="dc-btn dc-btn--outline">Annuler</a>
    <button type="submit" class="dc-btn dc-btn--primary">
        <i class="fa-solid fa-floppy-disk"></i>
        Enregistrer les modifications
    </button>
</div>

{{ form_end(form) }}

{% endblock %}
