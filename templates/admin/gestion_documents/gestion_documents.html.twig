{% extends 'admin/admin_base.html.twig' %}

{% block title %}Gestion des documents{% endblock %}

{% block body %}

{% include 'components/_flash_messages.html.twig' %}

<div class="mb-4">
    <h1 class="admin-page-header__title">
        Gestion des documents
        {% if logs is defined %}
            <span class="dc-count-badge">{{ logs|length }}</span>
        {% endif %}
    </h1>
    <p class="admin-page-header__sub">Déposez et gérez les documents pour les utilisateurs.</p>
</div>

<div class="row g-4 align-items-start">

    {# Colonne gauche : listes #}
    <div class="col-12 col-xl-8">

        <div class="dc-toolbar mb-3">
            <div class="dc-search">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" class="dc-search__input" placeholder="Rechercher un document, un utilisateur…">
            </div>
        </div>

        {# ── Section 1 : Documents envoyés par les admins → utilisateurs ── #}
        <div class="dc-card mb-4">
            <div class="dc-card__head">
                <span class="dc-card__title">
                    <i class="fa-solid fa-file-export"></i>
                    Documents envoyés aux utilisateurs
                    <span class="dc-count-badge ms-2">{{ logs|length }}</span>
                </span>
            </div>
            <div class="dc-card__body p-0">
                {% if logs is not defined or logs is empty %}
                    <div class="dc-empty-state">
                        <i class="fa-solid fa-inbox"></i>
                        <p>Aucun document envoyé pour le moment.</p>
                    </div>
                {% else %}
                    <div class="table-responsive">
                        <table class="dc-table" id="docsTable">
                            <thead>
                                <tr>
                                    <th>Document</th>
                                    <th class="d-none d-md-table-cell">Destinataire</th>
                                    <th class="d-none d-lg-table-cell">Déposé par</th>
                                    <th class="d-none d-lg-table-cell">Déposé le</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in logs %}
                                {% set ext = doc.fichier|split('.')|last|lower %}
                                <tr>
                                    <td>
                                        <div class="file-cell">
                                            <span class="file-icon file-icon--{{ ext == 'pdf' ? 'pdf' : (ext in ['doc','docx'] ? 'doc' : (ext in ['xls','xlsx'] ? 'xls' : 'other')) }}">
                                                <i class="fa-solid {{ ext == 'pdf' ? 'fa-file-pdf' : (ext in ['doc','docx'] ? 'fa-file-word' : (ext in ['xls','xlsx'] ? 'fa-file-excel' : 'fa-file')) }}"></i>
                                            </span>
                                            <div>
                                                <div class="file-cell__name">{{ doc.nom }}</div>
                                                <div class="file-cell__ext">{{ ext|upper }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <div class="user-cell">
                                            <span class="dc-avatar dc-avatar--sm">
                                                {{ doc.destinataire.prenom|first|upper }}{{ doc.destinataire.nom|first|upper }}
                                            </span>
                                            <div>
                                                <div class="user-cell__name">{{ doc.destinataire.prenom }} {{ doc.destinataire.nom }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="d-none d-lg-table-cell dc-table__muted">
                                        {{ doc.deposePar ? doc.deposePar.prenom ~ ' ' ~ doc.deposePar.nom : '—' }}
                                    </td>
                                    <td class="d-none d-lg-table-cell dc-table__muted">
                                        {{ doc.deposeLe ? doc.deposeLe|date('d/m/Y') : '—' }}
                                    </td>
                                    <td>
                                        <div class="dc-actions justify-content-end">
                                            <a href="{{ path('app_download_gestion_documents', {id: doc.id}) }}"
                                               class="dc-btn dc-btn--outline dc-btn--sm"
                                               title="Télécharger">
                                                <i class="fa-solid fa-download"></i>
                                            </a>
                                            <form method="post"
                                                  action="{{ path('app_annuler_gestion_documents', {id: doc.id}) }}"
                                                  onsubmit="return confirm('Supprimer ce document ? Cette action est irréversible.')">
                                                <input type="hidden" name="_token" value="{{ csrf_token('annuler' ~ doc.id) }}">
                                                <button type="submit" class="dc-btn dc-btn--danger dc-btn--sm" title="Supprimer">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>

        {# ── Section 2 : Documents déposés par les utilisateurs ── #}
        <div class="dc-card">
            <div class="dc-card__head">
                <span class="dc-card__title">
                    <i class="fa-solid fa-file-import"></i>
                    Documents reçus des utilisateurs
                    <span class="dc-count-badge ms-2">{{ documentsUtilisateurs|length }}</span>
                </span>
            </div>
            <div class="dc-card__body p-0">
                {% if documentsUtilisateurs is empty %}
                    <div class="dc-empty-state">
                        <i class="fa-solid fa-inbox"></i>
                        <p>Aucun document déposé par les utilisateurs pour le moment.</p>
                    </div>
                {% else %}
                    <div class="table-responsive">
                        <table class="dc-table" id="docsUtilisateursTable">
                            <thead>
                                <tr>
                                    <th>Document</th>
                                    <th class="d-none d-md-table-cell">Déposé par</th>
                                    <th class="d-none d-lg-table-cell">Date de dépôt</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in documentsUtilisateurs %}
                                {% set ext = doc.fichier|split('.')|last|lower %}
                                <tr>
                                    <td>
                                        <div class="file-cell">
                                            <span class="file-icon file-icon--{{ ext == 'pdf' ? 'pdf' : (ext in ['doc','docx'] ? 'doc' : (ext in ['xls','xlsx'] ? 'xls' : 'other')) }}">
                                                <i class="fa-solid {{ ext == 'pdf' ? 'fa-file-pdf' : (ext in ['doc','docx'] ? 'fa-file-word' : (ext in ['xls','xlsx'] ? 'fa-file-excel' : 'fa-file')) }}"></i>
                                            </span>
                                            <div>
                                                <div class="file-cell__name">{{ doc.nom }}</div>
                                                <div class="file-cell__ext">{{ ext|upper }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <div class="user-cell">
                                            <span class="dc-avatar dc-avatar--sm">
                                                {{ doc.utilisateur.prenom|first|upper }}{{ doc.utilisateur.nom|first|upper }}
                                            </span>
                                            <div>
                                                <div class="user-cell__name">{{ doc.utilisateur.prenom }} {{ doc.utilisateur.nom }}</div>
                                                <div class="dc-table__muted small">{{ doc.utilisateur.email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="d-none d-lg-table-cell dc-table__muted">
                                        {{ doc.date ? doc.date|date('d/m/Y à H:i') : '—' }}
                                    </td>
                                    <td>
                                        <div class="dc-actions justify-content-end">
                                            <a href="{{ path('app_download_utilisateur_document', {id: doc.id}) }}"
                                               class="dc-btn dc-btn--outline dc-btn--sm"
                                               title="Télécharger / Consulter">
                                                <i class="fa-solid fa-download"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>

    </div>

    {# Colonne droite : formulaire dépôt #}
    <div class="col-12 col-xl-4">
        <div class="dc-card depot-form-card">
            <div class="dc-card__head">
                <span class="dc-card__title">
                    <i class="fa-solid fa-file-arrow-up"></i>
                    Déposer un document
                </span>
            </div>
            <div class="dc-card__body">

                {{ form_start(form, {attr: {novalidate: 'novalidate'}}) }}

                    <div class="mb-3">
                        <label class="dc-form-label" for="{{ form.nom.vars.id }}">Nom du document</label>
                        {{ form_widget(form.nom, {attr: {class: 'dc-form-control', placeholder: 'Ex : Rapport mensuel…'}}) }}
                        {{ form_errors(form.nom) }}
                    </div>

                    <div class="mb-3">
                        <label class="dc-form-label" for="{{ form.destinataire.vars.id }}">Destinataire</label>
                        {{ form_widget(form.destinataire, {attr: {class: 'dc-form-control'}}) }}
                        {{ form_errors(form.destinataire) }}
                    </div>

                    <div class="mb-4">
                        <label class="dc-form-label">Fichier <span class="text-danger">*</span></label>
                        <div class="drop-zone" id="dropZone">
                            {{ form_widget(form.fichierFile, {attr: {id: 'fileInput', class: 'drop-zone__input'}}) }}
                            <i class="fa-solid fa-cloud-arrow-up drop-zone__icon"></i>
                            <p class="drop-zone__text" id="dropZoneText">Glissez votre fichier ici ou cliquez</p>
                            <p class="drop-zone__hint">PDF, Word, Excel, images — 10 Mo max</p>
                        </div>
                        {{ form_errors(form.fichierFile) }}
                    </div>

                    <button type="submit" class="dc-btn dc-btn--primary w-100 justify-content-center">
                        <i class="fa-solid fa-paper-plane"></i>
                        Déposer le document
                    </button>

                {{ form_end(form) }}

            </div>
        </div>
    </div>

</div>

{% endblock %}
